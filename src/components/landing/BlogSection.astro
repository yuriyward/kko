---
import jakZnajty from "@assets/images/jak_znajty.webp";
import kolyRiszenia from "@assets/images/koly_riszenia.webp";
import zustriczi from "@assets/images/zustriczi.webp";
import KateMiniProfile from "@assets/images/kate-mini-profile.png";
import BlogCard from "./BlogCard.astro";

const blogPosts = [
    {
        id: 1,
        title: "Як знайти людей, які підсилять ваш бізнес: баланс хард та софт скілів",
        description:
            "Ми хочемо залишатися на шляху успіху, знайшовши правильних людей для нашої команди.",
        image: jakZnajty,
        author: "Катерина Кошенко",
        readTime: "3 хв",
        url: "https://medium.com/@koshenko.kate/як-знайти-людей-які-підсилять-ваш-бізнес-баланс-хард-та-софт-скілів-bf4903f667d9",
    },
    {
        id: 2,
        title: "Коли рішення підтримують цінності, і навпаки",
        description: "Ефективний процес прийняття рішень у бізнесі",

        image: kolyRiszenia,
        author: "Катерина Кошенко",
        readTime: "5 хв",
        url: "https://medium.com/@koshenko.kate/https-medium-com-koshenko-katia-values-guide-us-f92f73ac910a",
    },
    {
        id: 3,
        title: "Зустрічі один на один",
        description: "Сила регурярних 1:1 зустрічей у команді",
        image: zustriczi,
        author: "Катерина Кошенко",
        readTime: "6 хв",
        url: "https://medium.com/@koshenko.kate/зустрічі-один-на-один-a117076d9d4f",
    },
    {
        id: 4,
        title: "Як ставити цілі для особистого розвитку: методика OKR",
        description:
            "Здебільшого OKR використовуються для досягнення бізнес-цілей у компаніях. Але ця методика може стати в пригоді також як інструмент для особистісного розвитку...",
        image: "https://happymonday.ua/wp-content/uploads/2024/09/OKR-940x528.png",
        author: "Катерина Кошенко",
        readTime: "4 хв",
        url: "https://happymonday.ua/okr-dlya-osobystogo-rozvytku",
    },
    {
        id: 5,
        title: "Культурний інтелект (CQ)",
        description:
            "Як краще зрозуміти колег різних культур та налагодити з ними ефективну комунікацію? Суттєву роль у цьому відіграє культурний інтелект (CQ). Що це таке та як його розвинути...",
        image: "https://happymonday.ua/wp-content/uploads/2024/07/CQ-940x528.png",
        author: "Катерина Кошенко",
        readTime: "7 хв",
        url: "https://happymonday.ua/kulturnyj-intelekt-cq",
    },
];

const totalPosts = blogPosts.length;
---

<section
    id="blog"
    class="w-full flex flex-col items-center gap-12 py-20 bg-gray-50"
>
    <h1 class="text-displayMedium text-center px-4">
        Слідкуйте за моїм блогом
    </h1>

    <div class="w-full max-w-screen-2xl mx-auto relative px-2 sm:px-3 lg:px-4">
        <div id="blog-carousel-viewport" class="overflow-hidden w-full">
            <div
                id="blog-carousel-track"
                class="flex transition-transform duration-500 ease-in-out -mx-3 relative"
                style="visibility: hidden;"
            >
                {
                    blogPosts.map((post) => (
                        <div class="flex-shrink-0 w-full md:w-1/2 xl:w-1/3 px-3 blog-post-slide">
                            <BlogCard
                                title={post.title}
                                description={post.description}
                                image={post.image}
                                author={post.author}
                                authorImage={KateMiniProfile}
                                date={`Читати ${post.readTime}`}
                                url={post.url}
                                class="h-full flex flex-col"
                            />
                        </div>
                    ))
                }
            </div>
        </div>

        {
            totalPosts > 1 && (
                <>
                    <button
                        id="prev-button"
                        aria-label="Previous blog posts"
                        style="display: none;"
                        class="absolute left-1 sm:left-2 md:left-4 lg:-left-6 top-1/2 transform -translate-y-1/2 z-10 bg-white p-2.5 rounded-full shadow-lg hover:bg-gray-100 transition-all duration-300 focus:outline-none focus:ring-0 focus:shadow-lg"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"
                        >
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>
                    <button
                        id="next-button"
                        aria-label="Next blog posts"
                        style="display: none;"
                        class="absolute right-1 sm:right-2 md:right-4 lg:-right-6 top-1/2 transform -translate-y-1/2 z-10 bg-white p-2.5 rounded-full shadow-lg hover:bg-gray-100 transition-all duration-300 focus:outline-none focus:ring-0 focus:shadow-lg"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"
                        >
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </button>
                </>
            )
        }
        <div class="flex justify-center w-full mt-8">
            <div
                id="pagination-dots"
                style="display: none;"
                class="inline-flex justify-center items-center space-x-2 p-2 px-3 rounded-full bg-primary-cotton"
            >
            </div>
        </div>
    </div>
</section>

<script define:vars={{ totalPosts }}>
    const viewport = document.getElementById("blog-carousel-viewport");
    const track = document.getElementById("blog-carousel-track");
    const slides = track ? Array.from(track.children) : [];
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");
    const dotsContainer = document.getElementById("pagination-dots");

    let currentPage = 0;
    let itemsPerPage = 1;
    let totalPages = 1;

    function getItemsPerPage() {
        const viewportWidth = window.innerWidth;
        if (viewportWidth >= 1280) return 3;
        if (viewportWidth >= 768) return 2;
        return 1;
    }

    function calculatePages() {
        if (slides.length === 0) return;
        itemsPerPage = getItemsPerPage();
        totalPages = Math.ceil(totalPosts / itemsPerPage);

        if (currentPage >= totalPages) {
            currentPage = Math.max(0, totalPages - 1);
        }
    }

    function updateDots() {
        if (!dotsContainer) return;
        dotsContainer.innerHTML = "";

        if (totalPages <= 1) {
            dotsContainer.style.display = "none";
            return;
        }
        dotsContainer.style.display = "flex";

        for (let i = 0; i < totalPages; i++) {
            const dot = document.createElement("button");
            dot.setAttribute("aria-label", `Go to page ${i + 1}`);
            dot.className = `w-2 h-2 rounded-full transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ${
                currentPage === i
                    ? "bg-indigo-600 scale-125"
                    : "bg-gray-300 hover:bg-gray-400"
            }`;
            dot.addEventListener("click", () => goToPage(i));
            dotsContainer.appendChild(dot);
        }
    }

    function updateButtonVisibility() {
        const showControls = totalPosts > itemsPerPage;
        if (prevButton)
            prevButton.style.display = showControls ? "block" : "none";
        if (nextButton)
            nextButton.style.display = showControls ? "block" : "none";
    }

    function goToPage(pageNumber) {
        if (!track || slides.length === 0) return;

        // Handle Looping & Clamping based on calculated totalPages
        if (totalPages <= 1) {
            pageNumber = 0; // Only page 0 exists
        } else if (pageNumber < 0) {
            pageNumber = totalPages - 1;
        } else if (pageNumber >= totalPages) {
            pageNumber = 0;
        }

        currentPage = pageNumber;

        // Determine the index of the first slide that should be visible for the target page
        const targetSlideIndex = Math.min(
            currentPage * itemsPerPage,
            slides.length - 1
        );

        let offset = 0;
        if (slides[targetSlideIndex]) {
            // offsetLeft is the distance from the slide's left edge to the track's left edge
            offset = -slides[targetSlideIndex].offsetLeft;
        }

        track.style.transform = `translateX(${offset}px)`;

        updateDots();
        updateButtonVisibility();
    }

    function nextPage() {
        goToPage(currentPage + 1);
    }

    function prevPage() {
        goToPage(currentPage - 1);
    }

    let resizeTimeout;
    function handleResize() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // Recalculate page structure
            calculatePages();
            // Re-apply transform based on the *current* page index and NEW slide positions
            goToPage(currentPage);
            // Update UI based on new calculations
            updateDots();
            updateButtonVisibility();
        }, 250);
    }

    function initCarousel() {
        if (!track || !viewport || slides.length === 0 || totalPosts === 0) {
            console.warn("Carousel init skipped.");
            if (track) track.style.visibility = "visible"; // Make sure it's visible even if skipped
            return;
        }

        calculatePages();

        if (totalPosts > 1) {
            // Add listeners only if sliding is possible
            prevButton?.addEventListener("click", prevPage);
            nextButton?.addEventListener("click", nextPage);
            window.addEventListener("resize", handleResize);
        }

        updateDots();
        updateButtonVisibility();
        // Set initial position *after* calculating pages
        goToPage(0);

        // Make track visible after setup
        track.style.visibility = "visible";
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCarousel);
    } else {
        initCarousel();
    }
</script>

<style>
    #blog-carousel-track {
        will-change: transform;
        position: relative;
    }
    #prev-button,
    #next-button {
        z-index: 10;
    }
</style>
